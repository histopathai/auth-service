name: Deploy Auth Service

on:
  push:
    branches:
      - main # prod
      - dev # dev
    paths:
      - "auth-service/**"
      - ".github/workflows/deploy-auth-service.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        type: choice
        options:
          - dev
          - prod

env:
  TF_VERSION: "1.5.0"
  REPO_NAME: auth-service

permissions:
  contents: read
  id-token: write

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - name: Determine Environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENVIRONMENT="${{ inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENVIRONMENT="prod"
          elif [ "${{ github.ref }}" == "refs/heads/dev" ]; then
            ENVIRONMENT="dev"
          else
            ENVIRONMENT="dev"
          fi

          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "ğŸŒ Environment: ${ENVIRONMENT}"

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: setup
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
      WIF_PROVIDER: ${{ secrets.WIF_PROVIDER}}
      WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT}}
      TF_STATE_BUCKET: ${{ secrets.TF_STATE_BUCKET }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Set up Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GCP Project Info
        id: gcp-info
        run: |
          PROJECT_ID=$(gcloud config get-value project)
          PROJECT_NUMBER=$(gcloud projects describe ${PROJECT_ID} --format="value(projectNumber)")
          REGION="${{ secrets.GCP_REGION }}"

          echo "project_id=${PROJECT_ID}" >> $GITHUB_OUTPUT
          echo "project_number=${PROJECT_NUMBER}" >> $GITHUB_OUTPUT
          echo "region=${REGION}" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Project ID: ${PROJECT_ID}"
          echo "ğŸ”¢ Project Number: ${PROJECT_NUMBER}"
          echo "ğŸŒ Region: ${REGION}"

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ steps.gcp-info.outputs.region }}-docker.pkg.dev

      - name: Install Go Tools (swag)
        run: |
          go install github.com/swaggo/swag/cmd/swag@latest

      - name: Generate Swagger Documentation
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          swag init -g cmd/main.go
          echo "âœ… Swagger docs generated"

      - name: Build Docker Image
        run: |
          IMAGE_TAG="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ github.sha }}"
          IMAGE_LATEST="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:latest"
          IMAGE_ENV="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ env.ENVIRONMENT }}"

          docker build \
            --tag ${IMAGE_TAG} \
            --tag ${IMAGE_LATEST} \
            --tag ${IMAGE_ENV} \
            .

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ³ Built image: ${IMAGE_TAG}"

      - name: Push Docker Image
        run: |
          IMAGE_TAG="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ github.sha }}"
          IMAGE_LATEST="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:latest"
          IMAGE_ENV="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ env.ENVIRONMENT }}"

          docker push ${IMAGE_TAG}
          docker push ${IMAGE_LATEST}
          docker push ${IMAGE_ENV}

          echo "ğŸš€ Pushed all image tags"

      - name: Output Image Info
        id: image-info
        run: |
          IMAGE_TAG="${{ steps.gcp-info.outputs.region }}-docker.pkg.dev/${{ steps.gcp-info.outputs.project_id }}/histopath-docker-repo/${{ env.REPO_NAME }}:${{ github.sha }}"
          echo "image=${IMAGE_TAG}" >> $GITHUB_OUTPUT

    outputs:
      image: ${{ steps.image-info.outputs.image }}
      project_id: ${{ steps.gcp-info.outputs.project_id }}
      project_number: ${{ steps.gcp-info.outputs.project_number }}
      region: ${{ steps.gcp-info.outputs.region }}

  terraform-deploy:
    name: Terraform Deploy
    runs-on: ubuntu-latest
    needs: [setup, build-and-push]
    environment:
      name: ${{ needs.setup.outputs.environment }}

    env:
      WIF_PROVIDER: ${{secrets.WIF_PROVIDER}}
      WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      TF_STATE_BUCKET: ${{ secrets.TF_STATE_BUCKET }}

      ARTIFACT_REGISTRY_REPO_NAME: ${{ secrets.ARTIFACT_REGISTRY_REPO_NAME }}
      GCP_REGION: ${{ secrets.GCP_REGION }}

    defaults:
      run:
        working-directory: ./infrastructure

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify GCP Authentication
        run: |
          echo "ğŸ” Authenticated as:"
          gcloud auth list
          echo ""
          echo "ğŸ“¦ Current project:"
          gcloud config get-value project
          echo ""
          echo "ğŸŒ Environment: ${{ needs.setup.outputs.environment }}"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          echo "ğŸ”§ Initializing Terraform for ${{ needs.setup.outputs.environment }}..."
          terraform init \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="prefix=services/auth-service/${{ needs.setup.outputs.environment }}"

      - name: Cleanup Orphaned State
        run: |
          export TF_VAR_project_id="${{ needs.build-and-push.outputs.project_id }}"
          export TF_VAR_region="${{ env.GCP_REGION }}"
          export TF_VAR_environment="${{ needs.setup.outputs.environment }}"
          export TF_VAR_tf_state_bucket="${{ env.TF_STATE_BUCKET }}"
          export TF_VAR_image_tag="temp" # Image tag not critical for import, just needs to exist

          chmod +x cleanup_state.sh
          ./cleanup_state.sh || true
        working-directory: ./infrastructure

      - name: Terraform Plan
        run: |
          echo "ğŸ“Š Running Terraform plan..."

          IMAGE_TAG="${{ env.GCP_REGION }}-docker.pkg.dev/${{ needs.build-and-push.outputs.project_id }}/${{ env.ARTIFACT_REGISTRY_REPO_NAME }}/${{ env.REPO_NAME }}:${{ github.sha }}"

          # -var-file kullanÄ±larak ortam bazlÄ± deÄŸiÅŸken dosyasÄ± seÃ§iliyor
          terraform plan \
            -var-file="${{ needs.setup.outputs.environment }}.tfvars" \
            -var="image_tag=${IMAGE_TAG}" \
            -var="tf_state_bucket=${{ env.TF_STATE_BUCKET }}" \
            -out=tfplan

      - name: Terraform Apply
        run: |
          echo "ğŸš€ Applying Terraform changes for ${{ needs.setup.outputs.environment }}..."
          terraform apply -auto-approve tfplan

      - name: Terraform Output
        id: tf-output
        run: |
          echo "ğŸ“¤ Terraform Outputs:"
          terraform output -json > terraform-outputs.json
          cat terraform-outputs.json

          SERVICE_URL=$(terraform output -raw service_url)
          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo ""
          echo "âœ… Service URL: ${SERVICE_URL}"

      - name: Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ needs.setup.outputs.environment }}
          path: infrastructure/terraform-outputs.json
          retention-days: 30

      - name: Cleanup Sensitive Files
        if: always()
        run: rm -f tfplan

      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Environment: ${{ needs.setup.outputs.environment }}"
          echo "ğŸ³ Image: ${{ needs.build-and-push.outputs.image }}"
          echo "ğŸ”— Service URL: ${{ steps.tf-output.outputs.service_url }}"

    outputs:
      service_url: ${{ steps.tf-output.outputs.service_url }}

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [setup, build-and-push, terraform-deploy]
    if: always()

    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.terraform-deploy.result }}" == "success" ]; then
            echo "âœ… Deployment successful!"
            echo "ğŸŒ Environment: ${{ needs.setup.outputs.environment }}"
            echo "ğŸ”— Service URL: ${{ needs.terraform-deploy.outputs.service_url }}"
          else
            echo "âŒ Deployment failed!"
            echo "ğŸŒ Environment: ${{ needs.setup.outputs.environment }}"
            exit 1
          fi
